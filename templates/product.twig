<div class="product {% if product.kit %}kit{% endif %}">

	{% section 'product-info' %}

    {% if theme.settings.customize_position_customize == "before_description" %}
    	{% section 'customize-product' %}
    {% endif %}

    {% if product.description or product.features %}
	    {% section 'product-description' %}
    {% endif %}
	
    {% section 'product-badge-list' %}

	<div class="container">
		<div id="yv-reviews"></div>
		<div class="yv-qa"></div>
	</div>

	{% if theme.settings.customize_position_customize != "before_buy" and theme.settings.customize_position_customize != "before_description" %}
		{% section 'customize-product' %}
	{% endif %}

    <div class="container mt-5" style="max-width: 800px;">
        <div id="disqus_thread"></div>
    </div>

	{% if product.hotsite_id %}
		{% section 'product-hotsite' %}
	{% endif %}

	{% app 'buy-together' %}
	{% section 'product-related' %}

	<div id="review-widget"></div>

    <div id="smarthint-position-1"></div>
    <div id="smarthint-position-2"></div>
    <div id="smarthint-position-3"></div>
    <div id="smarthint-position-4"></div>
    <div id="smarthint-position-5"></div>
</div>

{% ajax 'direct' hidden %}
    {
        "image1": "{{ product.images[0].src }}",
        "image2": "{{ product.images[1].src }}",
        "grid_id": "{{ product.grid_id }}"
    }
{% endajax %}

{% ajax 'product' hidden %}
    {% if product.colors|length > 1 %}
            <div class="row align-items-center no-gutters mb-4">
                <div class="col-1">
                    <div class="cv-prev" id="col-prev">
                        <i>{{ 'img/arrow-left.svg' | svg }}</i>
                    </div>
                </div>

                <div class="col-10">
                    <div class="cv-colors owl-carousel owl-theme">
                        {% for color in product.colors %}
                            <div class="cv-color {% if color.id == product.color_id %} active {% endif %}" data-url="{{ color.url }}" data-img-src="{{ color.product_images[0].src }}" data-img-rpt="{{ color.product_images[1].src }}">
                                <i style="background-color: {{ color.hexadecimal }}; background-image: url({{ color.image | img_url() }});"></i>
                            </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="col-1">
                    <div class="cv-next" id="col-next">
                        <i>{{ 'img/arrow-right.svg' | svg }}</i>
                    </div>
                </div>
            </div>
        {% endif %}
        
    {% if product.balance > 0 %}
        {% if product.attribute|length >= 1 and product.attribute_secondary|length >= 1 %}
            {% set attributes = [] %}
            {% set attributes = attributes|merge([product.attribute]) %}
            {% set attributes = attributes|merge([product.attribute_secondary]) %}
            
            {% set variation = null %}
            {% set variations = product.variations|json_encode|raw %}
            
            {% if _get.attr1 and _get.attr2 %}
                {% for _variation in product.variations %}
                    {% if _variation.attribute_value_id == _get.attr1 and _variation.attribute_value_secondary_id == _get.attr2 %}
                        {% set variation = _variation.id %}
                    {% endif %}
                {% endfor %}
            {% endif %}

            <div class="product-attributes">
                {% for attribute in attributes %}
                    {% set last = loop.last %}
                    {% set s_attr = (last) ? _get.attr2 : _get.attr1 %}

                    <div class="product-attribute" {% if last and not _get.attr2 %}style="display: none;"{% endif %}>
                        <div class="row align-items-center py-3">
                            <div class="col">
                                <h3 class="h3 m-0">{{ attribute.name }}</h3>
                            </div>
                            <div class="col">
                                <div class="product-attribute-select position-relative">
                                    <select class="select product-attribute-action pa-select" name="attr-{{ loop.index }}" required="required">
                                        <option disabled selected value="">Selecione</option>
                                        {% for attr in attribute.values %}
                                            <option value="{{ attr.id }}" {% if s_attr == attr.id %}selected{% endif %}>
                                                {{ attr.name }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
            {% if variation %}
                <input type="hidden" name="variation_id" value="{{ variation }}">
            {% endif %} 
            <div class="row">
                <div class="col-12">
                    <div class="product-buy text-center">
                        <button type="submit" class="btn product-buy-button w-100" {% if not variation %} disabled {% endif %}>
                            Comprar
                        </button>
                    </div>
                </div>
            </div>
        {% elseif product.attribute and product.attribute.values | length >= 1 %}
            {% set attribute_name = product.attribute.name ?: 'Atributos' %}
            {% set variations = product.variations %}

            <div class="row align-items-center no-gutters mb-4">
                <div class="col-12">
                    <div class="product-attribute-select position-relative mt-3">
                        <select class="select product-attribute-action" name="variation_id" required="required">
                            <option disabled selected value="">{{ attribute_name }}</option>
                            {% for variation in variations %}
                                {% set active = (variation.id == product_variation) ? true : null %}
                                <option {% if active %} selected {% endif %} value="{{ variation.id }}" {% if variation.balance <= 0 and product.selling_out_of_stock == 0 %} disabled {% endif %}>
                                    {{ variation.attribute.name }}
                                    ({{ (variation.balance <= 0 and product.selling_out_of_stock == 0) ? 'Sem estoque' : 'Em estoque' }})
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-12">
                    <div class="product-buy text-center">
                        <button type="submit" class="btn product-buy-button w-100" disabled>
                            Comprar
                        </button>
                    </div>
                </div>
            </div>
        {% else %}
            <input type="hidden" name="variation_id" value="{{ product.variation.id }}">

            <div class="row">
                <div class="col-12">
                    <div class="product-buy text-center">
                        <button type="submit" class="btn product-buy-button w-100" {% if product.variations|length > 1 %} disabled {% endif %}>
                            Comprar
                        </button>
                    </div>
                </div>
            </div>
        {% endif %}
    {% else %}
        {% include 'product-request.twig' %}
    {% endif %}
{% endajax %}

{% if product.kit and is_ajax %}
    {% ajax 'collection-customize-buy' hidden %}
        <div class="d-none">
            {% set components = product.components %}
            {% set groups = product.component_groups %}
            {% set order = section.settings.order ?: 'group' %}
            {% set variation_select_type = section.settings.variation_select_type ?: 'select' %}
            {% set individual_buy = section.settings.buy_individual_products %}

            <form id="form-add-cart-custom" name="form_add_cart" class="customize-product" method="post" action="{{ 'cart' | action ('add') }}" data-url="{{ product.url }}">
            
            {% if theme.settings.customize_position_customize == "after_description" %}
                {% include 'section-title.twig' %}
            {% endif %}

            <input type="hidden" name="redirect" value="cart">
            <input type="hidden" name="variation_id" value="{{ product.variation.id }}">
            <input type="number" name="quantity" value="{{ _get.quantity ?: 1 }}">

            <div class="customize-product-loader">
                <div class="loader-bg">
                    <span class="loader"></span>
                </div>
            </div>

            <div class="customize-product-ajax">
                {% ajax 'customize-product' %}
                    <div class="container d-flex flex-column">
                        {% for group in groups %}
                            {% set is_first = 0 %}
                            {% set price = 0 %}

                            <div class="row customize-product-group pb-5 mt-5 {% if order == 'no_group'%}order-1{% endif %}">
                                <div class="col-12">
                                    <div class="mb-4">
                                        <h2 class="h2 mb-4">{{ group.name }} {% if group.optional %}(Opcional){% endif %}</h2>
                                        <p class="text">{{ group.description }}</p>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="customize-product-components">
                                        {% for component in components %}
                                            {% if group.id == component.product_component_group_id %}
                                                {% set isf = isf + 1 %}

                                                {% if component.selected or (isf == 1 and not group.optional) %}
                                                    {% set price = component.price %}
                                                {% endif %}
                                            {% endif %}
                                        {% endfor %}

                                        {% for component in components %}
                                            {% if group.id == component.product_component_group_id %}
                                                {% set is_first = is_first + 1 %}

                                                {% if group.optional and is_first == 1 %}
                                                    <label class="row customize-product-component d-flex align-items-center justify-content-start mt-4 py-1">
                                                        <div class="col-auto">
                                                            <div class="customize-product-radio">
                                                                <input type="radio" name="components[{{ group.id }}][product_component_id]" value="" {% if not component.selected %}checked{% endif %}>
                                                                <input type="radio" name="components[{{ group.id }}][variation_id]" value="" class="d-none" {% if not component.selected %}checked{% endif %}>
                                                                    
                                                                <span class="checkmark">
                                                                    <i>{{ 'img/dc-icons/check-bold.svg' | svg }}</i>
                                                                </span>
                                                            </div>
                                                        </div>

                                                        <div class="col-auto">
                                                            <div class="customize-product-image mr-3">
                                                                <div class="icon p-3">
                                                                    {{ 'img/dc-icons/image.svg' | svg }}
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <div class="col">
                                                            <div class="customize-product-title">
                                                                <h3 class="h3">Nenhum componente</h3>
                                                            </div>
                                                        </div>
                                                    </label>
                                                {% endif %}

                                                <label class="row customize-product-component d-flex align-items-center justify-content-start mt-4 py-1 {% if component.balance <= 0 and not component.selling_out_of_stock %}out-of-stock{% endif %}">
                                                    <div class="col-auto">
                                                        <div class="customize-product-radio">
                                                            <input type="radio" name="components[{{ group.id }}][product_component_id]" value="{{ component.product_component_id }}" {% if component.selected or (is_first == 1 and not group.optional) %}checked{% endif %}>
                                                            <span class="checkmark">
                                                                <i>{{ 'img/dc-icons/check-bold.svg' | svg }}</i>
                                                            </span>
                                                        </div>
                                                    </div>

                                                    <div class="col-auto">
                                                        <div class="customize-product-image mr-3">
                                                            {% if component.image.src %}
                                                                <img src="{{ component.image.src | img_url('60x60+filll_ffffff') }}" alt="{{ component.name }}" class="img-fluid">
                                                            {% else %}
                                                                <div class="icon p-3">
                                                                    {{ 'img/dc-icons/image.svg' | svg }}
                                                                </div>
                                                            {% endif %}
                                                        </div>
                                                    </div>

                                                    <div class="col">
                                                        <div class="customize-product-title">
                                                            <span class="h3">
                                                                {% if component.quantity > 1 %}
                                                                    {{ component.quantity }}x
                                                                {% endif %}
                                                                {{ component.name }}
                                                            </span>
                                                            {% if component.price != price %}
                                                                <span class="customize-product-price">
                                                                    {% set diff = component.price - price %}
                                                                    ({{ diff | currency }})
                                                                </span>
                                                            {% endif %}
                                                        </div>

                                                        {% if component.variations|length > 1 %}
                                                            {% if component.variation.attribute_value_id|length > 0 and component.variation.attribute_value_secondary_id|length > 0 %}
                                                                {% set _product = _getProduct(component.grid_id) %}
                                                                {% set attributes = [] %}
                                                                {% set attributes = attributes|merge([_product.attribute]) %}
                                                                {% set attributes = attributes|merge([_product.attribute_secondary]) %}
                                                                
                                                                {% set variation = null %}
                                                                {% set attr1 = null %}
                                                                {% set attr2 = null %}

                                                                {% if _get.attributesc[component.grid_id]|length > 0 %}
                                                                    {% set attr1 = _get.attributesc[component.grid_id]['attr-1'] ?: null %}
                                                                    {% set attr2 = _get.attributesc[component.grid_id]['attr-2'] ?: null %}
                                                                {% else %}
                                                                    {% for _variation in _product.variations %}
                                                                        {% if not attr1 and not attr2 %}
                                                                            {% if (_variation.balance >= 1) or _variation.selling_out_of_stock %}
                                                                                {% set attr1 = _variation.attribute_value_id ?: null %}
                                                                                {% set attr2 = _variation.attribute_value_secondary_id ?: null %}
                                                                            {% endif %}
                                                                        {% endif %}
                                                                    {% endfor %}
                                                                {% endif %}

                                                                {% if attr1 and attr2 %}
                                                                    {% for _variation in _product.variations %}
                                                                        {% if _variation.attribute_value_id == attr1 and _variation.attribute_value_secondary_id == attr2 %}
                                                                            {% set variation = _variation %}
                                                                        {% endif %}
                                                                    {% endfor %}
                                                                {% endif %}
                                                                
                                                                <div class="product-attributes">
                                                                    {% for attribute in attributes %}
                                                                        {% set last = loop.last %}
                                                                        {% set s_attr = (last) ? attr2 : attr1 %}

                                                                        <div class="product-attribute" {% if last and not attr2 %}style="display: none;"{% endif %}>
                                                                            <div class="row align-items-center mb-3">
                                                                                <div class="col">
                                                                                    <h4 class="h4 m-0">{{ attribute.name }}</h4>
                                                                                </div>
                                                                                <div class="col">
                                                                                    <div class="product-attribute-select position-relative">
                                                                                        <select class="select product-attribute-action attr-{{ loop.index }}" name="attributesc[{{ component.grid_id }}][attr-{{ loop.index }}]" required="required">
                                                                                            <option disabled selected value="">Selecione</option>
                                                                                            {% for attr in attribute.values %}
                                                                                                <option value="{{ attr.id }}" {% if s_attr == attr.id %}selected{% endif %}>
                                                                                                    {{ attr.name }}
                                                                                                </option>
                                                                                            {% endfor %}
                                                                                        </select>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    {% endfor %}
                                                                </div>
                                                                
                                                                {% if variation|length > 0 %}
                                                                    {% if variation.balance >= 1 or variation.selling_out_of_stock %}
                                                                        <input class="d-none" type="radio" name="components[{{ component.product_component_group_id }}][variation_id]" value="{{ variation.id }}" {% if component.selected or (is_first == 1 and not group.optional) %}checked{% endif %}>
                                                                    {% else %}
                                                                        <div class="customize-product-alert mb-3">
                                                                            <i>{{ 'img/dc-icons/exclamation.svg' | svg }}</i>
                                                                            Este produto não possui unidades em estoque.
                                                                        </div>
                                                                    {% endif %}
                                                                {% endif %}
                                                            {% elseif variation_select_type == 'buttons' %}
                                                                <div class="customize-product-buttons d-flex flex-wrap mb-2">
                                                                    {% for variation in component.variations %}
                                                                        {% set disabled = (variation.balance <= 0) ? 'disabled' : null %}
                                                                        
                                                                        <div class="customize-product-button mt-2 mr-2 p-2 {% if loop.first %}active{% endif %} {{ disabled }}" data-variation-id="{{ variation.id }}">
                                                                            <span class="text">{{ variation.attribute.name }}</span>
                                                                        </div>
                                                                    {% endfor %}

                                                                    <input class="d-none" type="radio" name="components[{{ component.product_component_group_id }}][variation_id]" value="{{ component.variations[0].id }}" {% if component.selected or (is_first == 1 and not group.optional) %}checked{% endif %}>
                                                                </div>
                                                            {% else %}
                                                                <div class="customize-product-select">
                                                                    <select class="select" name="components[{{ component.product_component_group_id }}][variation_id]">
                                                                        {% for variation in component.variations %}
                                                                            {% if variation.balance > 0 %}
                                                                                <option value="{{ variation.id }}">
                                                                                    {{ variation.attribute.name }}
                                                                                </option>
                                                                            {% endif %}
                                                                        {% endfor %}
                                                                    </select>

                                                                    <i class="select-icon">{{ 'img/arrow-down.svg' | svg }}</i>
                                                                </div>
                                                            {% endif %}
                                                        {% else %}
                                                            <div class="text my-2">{{ component.variations[0].attribute.name }}</div>
                                                            <input class="d-none" type="radio" name="components[{{ group.id }}][variation_id]" value="{{ component.variation.id }}" {% if component.selected or (is_first == 1 and not group.optional) %}checked{% endif %}>
                                                        {% endif %}

                                                        <div class="customize-product-detail" data-id="{{ component.product_component_id }}">
                                                            <span class="text">+ Detalhes</span>
                                                        </div>
                                                    </div>

                                                    {% if individual_buy %}
                                                        {% set buy_button_text = theme.settings.product_buy_button_text ?: 'Comprar' %}

                                                        <div class="col-auto">
                                                            <div class="btn customize-individual-buy position-relative" style="background-color: {{ theme.settings.color_button_buy }}; color: {{ theme.settings.color_button_buy_text }};" data-variation="components[{{ group.id }}][variation_id]">
                                                                <div class="product-action-buy-loader">
                                                                    <div class="loader"></div>
                                                                </div>
                                                                <span>{{ buy_button_text }}</span>
                                                            </div>
                                                        </div>
                                                    {% endif %}
                                                </label>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                            {# SEM GRUPOS #}
                            {% for component in components %}
                                {% if not component.product_component_group_id %}
                                    {% set index = loop.index %}
                                    <div class="row customize-product-component d-flex align-items-center justify-content-start py-4 no-group {% if order == 'no_group'%}order-0{% endif %}">
                                        <div class="d-none col-auto">
                                            <div class="customize-product-radio">
                                                <input type="radio" name="components[{{ loop.index }}][product_component_id]" value="{{ component.product_component_id }}" checked>
                                            </div>
                                        </div>
                                        
                                        <div class="col-auto">
                                            <div class="customize-product-image">
                                                {% if component.image.src %}
                                                    <img src="{{ component.image.src | img_url('60x60+filll_ffffff') }}" alt="{{ component.name }}" class="img-fluid">
                                                {% else %}
                                                    <div class="icon p-3">
                                                        {{ 'img/dc-icons/image.svg' | svg }}
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>

                                        <div class="col">
                                            <div class="customize-product-title">
                                                <span class="h3">
                                                    {% if component.quantity > 1 %}
                                                        {{ component.quantity }}x
                                                    {% endif %}
                                                    {{ component.name }}
                                                </span>
                                            </div>

                                            {% if component.variations|length > 1 %}
                                                {% if component.variation.attribute_value_id|length > 0 and component.variation.attribute_value_secondary_id|length > 0 %}
                                                    {% set _product = _getProduct(component.grid_id) %}
                                                    {% set attributes = [] %}
                                                    {% set attributes = attributes|merge([_product.attribute]) %}
                                                    {% set attributes = attributes|merge([_product.attribute_secondary]) %}
                                                    
                                                    {% set variation = null %}
                                                    {% set attr1 = null %}
                                                    {% set attr2 = null %}

                                                    {% if _get.attributes[index]|length > 0 %}
                                                        {% set attr1 = _get.attributes[index]['attr-1'] ?: null %}
                                                        {% set attr2 = _get.attributes[index]['attr-2'] ?: null %}
                                                    {% else %}
                                                        {% for _variation in _product.variations %}
                                                            {% if not attr1 and not attr2 %}
                                                                {% if (_variation.balance >= 1) or _variation.selling_out_of_stock %}
                                                                    {% set attr1 = _variation.attribute_value_id ?: null %}
                                                                    {% set attr2 = _variation.attribute_value_secondary_id ?: null %}
                                                                {% endif %}
                                                            {% endif %}
                                                        {% endfor %}
                                                    {% endif %}

                                                    {% if attr1 and attr2 %}
                                                        {% for _variation in _product.variations %}
                                                            {% if _variation.attribute_value_id == attr1 and _variation.attribute_value_secondary_id == attr2 %}
                                                                {% set variation = _variation %}
                                                            {% endif %}
                                                        {% endfor %}
                                                    {% endif %}
                                                    
                                                    <div class="product-attributes">
                                                        {% for attribute in attributes %}
                                                            {% set last = loop.last %}
                                                            {% set s_attr = (last) ? attr2 : attr1 %}

                                                            <div class="product-attribute" {% if last and not attr2 %}style="display: none;"{% endif %}>
                                                                <div class="row align-items-center mb-3">
                                                                    <div class="col">
                                                                        <h4 class="h4 m-0">{{ attribute.name }}</h4>
                                                                    </div>
                                                                    <div class="col">
                                                                        <div class="product-attribute-select position-relative">
                                                                            <select class="select product-attribute-action attr-{{ loop.index }}" name="attributes[{{ index }}][attr-{{ loop.index }}]" required="required">
                                                                                <option disabled selected value="">Selecione</option>
                                                                                {% for attr in attribute.values %}
                                                                                    <option value="{{ attr.id }}" {% if s_attr == attr.id %}selected{% endif %}>
                                                                                        {{ attr.name }}
                                                                                    </option>
                                                                                {% endfor %}
                                                                            </select>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        {% endfor %}
                                                    </div>
                                                    
                                                    {% if variation.balance >= 1 or variation.selling_out_of_stock %}
                                                        <input class="d-none" type="radio" name="components[{{ loop.index }}][variation_id]" value="{{ variation.id }}" checked>
                                                    {% else %}
                                                        <div class="customize-product-alert mb-3">
                                                            <i>{{ 'img/dc-icons/exclamation.svg' | svg }}</i>
                                                            Este produto não possui unidades em estoque.
                                                        </div>
                                                    {% endif %}
                                                {% elseif variation_select_type == 'buttons' %}
                                                    <div class="customize-product-buttons d-flex flex-wrap mb-2">
                                                        {% for variation in component.variations %}
                                                            {% set disabled = (variation.balance <= 0) ? 'disabled' : null %}
                                                                        
                                                            <div class="customize-product-button mt-2 mr-2 p-2 {% if loop.first %}active{% endif %} {{ disabled }}" data-variation-id="{{ variation.id }}">
                                                                <span class="text">{{ variation.attribute.name }}</span>
                                                            </div>
                                                        {% endfor %}

                                                        <input class="d-none" type="radio" name="components[{{ loop.index }}][variation_id]" value="{{ component.variations[0].id }}" checked>
                                                    </div>
                                                {% else %}
                                                    <div class="customize-product-select">
                                                        <select class="select" name="components[{{ loop.index }}][variation_id]">
                                                            {% for variation in component.variations %}
                                                                {% if variation.balance > 0 %}
                                                                    <option value="{{ variation.id }}">
                                                                        {{ variation.attribute.name }}
                                                                    </option>
                                                                {% endif %}
                                                            {% endfor %}
                                                        </select>
                                                        <i class="select-icon">{{ 'img/arrow-down.svg' | svg }}</i>
                                                    </div>
                                                {% endif %}
                                            {% else %}
                                                <div class="text my-2">{{ component.variations[0].attribute.name }}</div>
                                                <input type="hidden" name="components[{{ loop.index }}][variation_id]" value="{{ component.variation.id }}" checked>
                                            {% endif %}

                                            <div class="customize-product-detail" data-id="{{ component.product_component_id }}">
                                                <span class="text">+ Detalhes</span>
                                            </div>
                                        </div>

                                        {% if individual_buy %}
                                            {% set buy_button_text = theme.settings.product_buy_button_text ?: 'Comprar' %}

                                            <div class="col-auto">
                                                <div class="btn customize-individual-buy position-relative" style="background-color: {{ theme.settings.color_button_buy }}; color: {{ theme.settings.color_button_buy_text }};" data-variation="components[{{ loop.index }}][variation_id]">
                                                    <div class="product-action-buy-loader">
                                                        <div class="loader"></div>
                                                    </div>
                                                    <span>{{ buy_button_text }}</span>
                                                </div>
                                            </div>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            {% endfor %}
                    </div>

                    <div class="d-none quick-buy">
                        {% include 'product-action-price.twig' with { 'quick_buy': true } %}
                    </div>

                    <div class="d-none product-info">
                        {% include 'product-action-price.twig' %}
                    </div>
                {% endajax %}
            </div>

            {% for component in components %}
                {% include 'customize-product-modal.twig' with { 'id': component.product_component_id } %}
            {% endfor %}
        </form>
        </div>
    {% endajax %}
{% endif %}